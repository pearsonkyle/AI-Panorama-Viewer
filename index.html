<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Digital Dreams</title>
        <style>
            body { margin: 0; }
        </style>
    </head>
    <body>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

        <script type="module">
            import * as THREE from 'https://unpkg.com/three/build/three.module.js';

            // Our Javascript will go here.
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
            var queryID = '4bb10966-a1d1-4d99-a71b-8a14598375b8';
            
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            var texture = new THREE.TextureLoader().load( 'textures/sequoia.jpg' );
            var material = new THREE.MeshBasicMaterial( { map: texture } );

            var geometry = new THREE.SphereGeometry( 500, 60, 40 );
            // invert the geometry on the x-axis so that all of the faces point inward
            geometry.scale( - 1, 1, 1 );
            //const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            var mesh = new THREE.Mesh( geometry, material );
            scene.add( mesh );

            camera.position.z = 5;

            function animate() {
                requestAnimationFrame( animate );
                mesh.rotation.y += 0.0005;
                renderer.render( scene, camera );
            }
            animate();

        $(document).ready(function(){

            $("#submit").click(function(){
                // get the prompt from the text input field
                var prompt = $("#prompt").val();
                // create a JSON object with the prompt
                var data = {
                    "prompt": prompt,
                    "params": {
                        "cfg_scale": 9,
                        "sampler_name": "k_euler_a",
                        "height": 512,
                        "width": 1024,
                        "steps": 20,
                        "tiling": false,
                        "karras": true,
                        "hires_fix": false,
                        "clip_skip": 1,
                        "n": 1,
                        "seed": "2015274653",
                        "post_processing": [
                            "RealESRGAN_x4plus"
                        ]
                    },
                    "nsfw": true,
                    "censor_nsfw": false,
                    "trusted_workers": false,
                    "models": [
                        "stable_diffusion"
                    ],
                    "r2": true,
                    "shared": false
                };
                // send a POST request to the API
                $.ajax({
                    type: "POST",
                    url: "https://stablehorde.net/api/v2/generate/async",
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "apikey": "KAAOmTev_747cF7iKaN60w",
                        "Client-Agent": "unknown:0:unknown"
                    },
                    success: function(data){
                        // display the response message and id
                        //alert("Response: " + data.message + " ID: " + data.id);
                        // set the id in the text input field
                        $("#id").val(data.id);
                        queryID = data.id;
                        // check the status of the image generation
                        checkStatusLoop();
                    },
                    failure: function(errMsg) {
                        alert(errMsg);
                    }
                });
            });

            // make a new function to replicate curl
            // // curl -X 'GET' \
            //'https://stablehorde.net/api/v2/generate/status/82168bb9-8129-491d-b60b-f139014942c5' \
            //                    -H 'accept: application/json' \
            //                    -H 'Client-Agent: unknown:0:unknown'
            function checkStatus(id){
                $.ajax({
                    type: "GET",
                    url: "https://stablehorde.net/api/v2/generate/status/" + id,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "Client-Agent": "unknown:0:unknown"
                    },
                    success: function(data){
                        // display the response message and id
                        //alert("Finished: " + data.finished);
                        // reset the scene and load new image
                        scene.remove( mesh );
                        texture = new THREE.TextureLoader().load( data.generations[0].img );
                        material = new THREE.MeshBasicMaterial( { map: texture } );
                        mesh = new THREE.Mesh( geometry, material );
                        scene.add( mesh );
                        animate();
                    },
                    failure: function(errMsg) {
                        alert(errMsg);
                    }
                });
            }
            
            // checks status of image generation
            function checkStatusLoop(){
                // poll every 5 seconds in while loop
                var finished = 0;
                // get the id from the text input field
                var id = $("#id").val();

                    // send a GET request to the API
                    $.ajax({
                        type: "GET",
                        url: "https://stablehorde.net/api/v2/generate/check/" + id,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        headers: {
                            "Client-Agent": "unknown:0:unknown"
                        },
                        success: function(data){
                            // display the response message and id
                            alert("Finished: " + data.finished + "\nProcessing: " + data.processing);
                            // if finished check status and update image
                            if (data.finished){
                                checkStatus(queryID);
                            }
                            else{
                                const myTimeout = setTimeout(checkStatusLoop, 5000);
                            }
                            finished = data.finished;
                        },
                        failure: function(errMsg) {
                            alert(errMsg);
                        }
                    });
             }
            });
        </script>
        <!-- Add a centered text input and button -->
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <input type="text" id="prompt" placeholder="Enter your prompt" style="width: 200px; height: 30px; font-size: 20px; text-align: center;">
            <button id="submit" style="width: 200px; height: 30px; font-size: 20px;">Submit</button>
            <!-- <input type="text" id="id" placeholder="Enter your id" style="width: 200px; height: 30px; font-size: 20px; text-align: center;"> -->
        </div>
    </body>
</html>