<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Digital Dreams</title>
        <style>
            body { margin: 0; }
        </style>
    </head>
    <body>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

        <script type="module">
            import * as THREE from 'https://unpkg.com/three/build/three.module.js';

            var scene;
            var camera;
            var renderer;
            var texture;
            var material;
            var geometry;
            var mesh;
            var preprompt = "equirectangular panoramic, ";
            var endprompt = "unreal engine, VR360, artstation, symmetric";
            var id = "82168bb9-8129-491d-b60b-f139014942c5";
            var image_url = "textures/ai_pano.png";

            init();
            animate();

            function init() {
            // Our Javascript will go here.
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
            
            renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            texture = new THREE.TextureLoader().load( 'textures/ai_pano.png' );
            material = new THREE.MeshBasicMaterial( { map: texture } );

            geometry = new THREE.SphereGeometry( 500, 60, 40 );
            // invert the geometry on the x-axis so that all of the faces point inward
            geometry.scale( - 1, 1, 1 );
            //const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            mesh = new THREE.Mesh( geometry, material );
            scene.add( mesh );

            //camera.position.z = 5;
            // hide the progress bar
            }

            function animate() {
                requestAnimationFrame( animate );
                mesh.rotation.y += 0.0005;
                renderer.render( scene, camera );
            }

        $(document).ready(function(){

            $("#submit").click(function(){
                // get the prompt from the text input field
                var prompt = $("#prompt").val();
                // create a JSON object with the prompt
                var data = {
                    "prompt": preprompt + " " + prompt + ", " + endprompt,
                    "params": {
                        "cfg_scale": 9,
                        "sampler_name": "k_euler_a",
                        "height": 512,
                        "width": 1024,
                        "steps": 30,
                        "tiling": false,
                        "karras": true,
                        "hires_fix": true,
                        "clip_skip": 1,
                        "n": 1,
                        "seed": "2015274653",
                        "post_processing": [
                            "RealESRGAN_x4plus"
                        ]
                    },
                    "nsfw": true,
                    "censor_nsfw": false,
                    "trusted_workers": false,
                    "models": [
                        //"Deliberate"
                        //"Project Unreal Engine 5"
                        $("#model").val()
                    ],
                    "r2": true,
                    "shared": true
                };
                // send a POST request to the API
                $.ajax({
                    type: "POST",
                    url: "https://stablehorde.net/api/v2/generate/async",
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "apikey": "KAAOmTev_747cF7iKaN60w",
                        "Client-Agent": "unknown:0:unknown"
                    },
                    success: function(data){
                        // display the response message and id
                        //alert("Response: " + data.message + " ID: " + data.id);
                        // set the id in the text input field
                        id = data.id;
                        // check the status of the image generation
                        checkStatusLoop();
                    },
                    failure: function(errMsg) {
                        alert(errMsg);
                    }
                });
            });

            
        $(document).ready(function(){
            $("#download").click(function(){
                // save image from url
                var link = document.createElement('a');
                link.download = 'image.webp';
                link.href = image_url;
                link.click();
            });
        });


            // make a new function to replicate curl
            // // curl -X 'GET' \
            //'https://stablehorde.net/api/v2/generate/status/82168bb9-8129-491d-b60b-f139014942c5' \
            //                    -H 'accept: application/json' \
            //                    -H 'Client-Agent: unknown:0:unknown'
            function checkStatus(){
                $.ajax({
                    type: "GET",
                    url: "https://stablehorde.net/api/v2/generate/status/" + id,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "Client-Agent": "unknown:0:unknown"
                    },
                    success: function(data){
                        // display the response message and id
                        //alert("Finished: " + data.finished);
                        // reset the scene and load new image
                        scene.remove( mesh );
                        image_url = data.generations[0].img;
                        texture = new THREE.TextureLoader().load( data.generations[0].img );
                        material = new THREE.MeshBasicMaterial( { map: texture } );
                        mesh = new THREE.Mesh( geometry, material );
                        scene.add( mesh );
                        animate();
                    },
                    failure: function(errMsg) {
                        alert(errMsg);
                    }
                });
            }
            
            // checks status of image generation
            function checkStatusLoop(){
                // poll every 5 seconds in while loop
                var finished = 0;
                // get the id from the text input field

                    // send a GET request to the API
                    $.ajax({
                        type: "GET",
                        url: "https://stablehorde.net/api/v2/generate/check/" + id,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        headers: {
                            "Client-Agent": "unknown:0:unknown"
                        },
                        success: function(data){
                            // display the response message and id
                            alert("id: "+ id + "\nProcessing: " + data.processing + "\nFinished: " + data.finished);
                            // if finished check status and update image
                            if (data.finished){
                                checkStatus();
                            }
                            else{
                                const myTimeout = setTimeout(checkStatusLoop, 5000);
                            }
                            finished = data.finished;
                        },
                        failure: function(errMsg) {
                            alert(errMsg);
                        }
                    });


             }
            });
        </script>
        <div style="position: absolute; top: 90%; left: 50%; transform: translate(-50%, -50%);">
            <!-- Add two buttons at bottom of create with a long text input and centered submit -->
            <input type="text" id="prompt" style="width: 100%; height: 50px; font-size: 20px; text-align: center; margin: 0 auto; display: block;" placeholder="Describe a scene">
            <!-- Create dropdown to choose model -->
            <select id="model" style="width: 100%; height: 50px; font-size: 20px; text-align: center; margin: 0 auto; display: block;">
                <option value="Deliberate">Deliberate</option>
                <option value="Project Unreal Engine 5">Project Unreal Engine 5</option>
                <option value="stable_diffusion">Stable Diffusion</option>
            </select>
            
            <button id="submit" style="width: 50%; height: 50px; font-size: 20px; text-align: center; margin: 0 auto; display: block;">Create</button>
            <!-- download button -->
            <button id="download" style="width: 50%; height: 30px; font-size: 15px; text-align: center; margin: 0 auto; display: block;">Download</button>
        </div>
    </body>
</html>